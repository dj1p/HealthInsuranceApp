<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Insurance Quote Comparison</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .upload-section {
            padding: 50px 30px;
        }

        .upload-area {
            border: 3px dashed #d1d5db;
            border-radius: 15px;
            padding: 60px 30px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8fafc;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #4F46E5;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #4F46E5;
            background: #f0f4ff;
            transform: scale(1.02);
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .upload-icon svg {
            width: 40px;
            height: 40px;
            fill: white;
        }

        .upload-text {
            margin-bottom: 30px;
        }

        .upload-text h3 {
            font-size: 1.5rem;
            color: #1f2937;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upload-text p {
            color: #6b7280;
            font-size: 1rem;
            line-height: 1.6;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
        }

        .file-list {
            margin-top: 30px;
        }

        .file-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .file-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .file-info {
            display: flex;
            align-items: center;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: #fef3c7;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }

        .file-details h4 {
            color: #1f2937;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .file-details p {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .submit-section {
            padding: 30px;
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            margin-top: 20px;
            overflow: hidden;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4F46E5, #7C3AED);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .results-section {
            display: none;
            padding: 30px;
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .results-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
        }

        .download-btn {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .download-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #4F46E5;
        }

        .summary-card h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
        }

        .comparison-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            color: white;
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        td {
            padding: 16px 12px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: top;
        }

        tr:hover {
            background: #f8fafc;
        }

        .quote-row {
            transition: all 0.2s ease;
        }

        .quote-row:hover {
            background: #f0f4ff;
            transform: scale(1.01);
        }

        .best-value {
            background: #dcfce7 !important;
            font-weight: 600;
            color: #166534;
        }

        .company-name {
            font-weight: 600;
            color: #1f2937;
        }

        .plan-name {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .price {
            font-weight: 600;
            color: #059669;
        }

        .error-message {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .success-message {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .new-analysis-btn {
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .new-analysis-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .upload-section {
                padding: 30px 20px;
            }

            .upload-area {
                padding: 40px 20px;
            }

            .results-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }

            th, td {
                padding: 12px 8px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Insurance Quote Comparison</h1>
            <p>Upload your health insurance quote PDFs for instant comparison and analysis</p>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                </div>
                <div class="upload-text">
                    <h3>Drop your PDF files here</h3>
                    <p>or click to browse and select your health insurance quote PDFs</p>
                </div>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    Choose Files
                </button>
                <input type="file" id="fileInput" class="file-input" multiple accept=".pdf">
            </div>

            <div class="file-list" id="fileList"></div>
        </div>

        <div class="submit-section">
            <button class="submit-btn" id="submitBtn" disabled onclick="submitFiles()">
                Compare Insurance Quotes
            </button>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="success-message" id="successMessage">
                ✅ Files processed successfully! View your comparison below.
            </div>
            <div class="error-message" id="errorMessage">
                ❌ Error processing files. Please try again.
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2 class="results-title">Quote Comparison Results</h2>
                <div>
                    <button class="download-btn" onclick="downloadExcel()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        Download Excel
                    </button>
                </div>
            </div>

            <div class="summary-cards" id="summaryCards">
                <!-- Summary cards will be populated here -->
            </div>

            <div class="comparison-table">
                <div class="table-container">
                    <table id="comparisonTable">
                        <thead>
                            <tr>
                                <th>Insurance Company</th>
                                <th>Plan Name</th>
                                <th>Monthly Premium</th>
                                <th>Annual Premium</th>
                                <th>Deductible</th>
                                <th>Out of Pocket Max</th>
                                <th>Primary Care Copay</th>
                                <th>Specialist Copay</th>
                                <th>Network Type</th>
                                <th>Emergency Room</th>
                                <th>Prescription Coverage</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Table rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <button class="new-analysis-btn" onclick="startNewAnalysis()">
                Start New Analysis
            </button>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let comparisonData = [];
        const maxFiles = 10;

        // Your n8n webhook URL - replace with your actual webhook URL
        const WEBHOOK_URL = 'https://insurance.scrapfur.org/webhook/insurance-quotes';

        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const submitBtn = document.getElementById('submitBtn');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const uploadSection = document.getElementById('uploadSection');
        const resultsSection = document.getElementById('resultsSection');

        // File input change handler
        fileInput.addEventListener('change', handleFileSelect);

        // Drag and drop handlers
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFileSelect({target: {files: e.dataTransfer.files}});
        });

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            
            // Filter PDF files only
            const pdfFiles = files.filter(file => file.type === 'application/pdf');
            
            if (pdfFiles.length !== files.length) {
                alert('Please select only PDF files.');
                return;
            }

            // Check file limit
            if (selectedFiles.length + pdfFiles.length > maxFiles) {
                alert(`Maximum ${maxFiles} files allowed.`);
                return;
            }

            // Add files to selection
            pdfFiles.forEach(file => {
                if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    selectedFiles.push(file);
                }
            });

            updateFileList();
            updateSubmitButton();
        }

        function updateFileList() {
            fileList.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">📄</div>
                        <div class="file-details">
                            <h4>${file.name}</h4>
                            <p>${formatFileSize(file.size)} • PDF</p>
                        </div>
                    </div>
                    <button class="remove-btn" onclick="removeFile(${index})">Remove</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
            updateSubmitButton();
        }

        function updateSubmitButton() {
            submitBtn.disabled = selectedFiles.length === 0;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function submitFiles() {
            if (selectedFiles.length === 0) return;

            submitBtn.disabled = true;
            progressBar.style.display = 'block';
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';

            try {
                const formData = new FormData();
                
                selectedFiles.forEach((file, index) => {
                    formData.append(`file_${index}`, file);
                });

                // Add metadata
                formData.append('timestamp', new Date().toISOString());
                formData.append('file_count', selectedFiles.length.toString());

                // Simulate progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 20;
                    if (progress > 85) progress = 85;
                    progressFill.style.width = progress + '%';
                }, 300);

                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                progressFill.style.width = '100%';

                if (response.ok) {
                    const result = await response.json();
                    
                    setTimeout(() => {
                        comparisonData = result.data.quotes || [];
                        displayResults(result.data);
                        successMessage.style.display = 'block';
                        progressBar.style.display = 'none';
                        
                        // Show results and hide upload
                        resultsSection.style.display = 'block';
                        uploadSection.style.display = 'none';
                    }, 500);
                } else {
                    throw new Error('Processing failed');
                }

            } catch (error) {
                console.error('Processing error:', error);
                errorMessage.style.display = 'block';
                progressBar.style.display = 'none';
            } finally {
                submitBtn.disabled = false;
            }
        }

        function displayResults(data) {
            displaySummaryCards(data);
            displayComparisonTable(data.quotes);
        }

        function displaySummaryCards(data) {
            const summaryCards = document.getElementById('summaryCards');
            const quotes = data.quotes || [];
            
            if (quotes.length === 0) return;

            // Calculate summary statistics
            const monthlyPremiums = quotes.map(q => parseFloat(q.monthly_premium) || 0).filter(p => p > 0);
            const deductibles = quotes.map(q => parseFloat(q.deductible) || 0).filter(d => d > 0);
            
            const summaryData = [
                {
                    title: 'Total Quotes',
                    value: quotes.length,
                    color: '#4F46E5'
                },
                {
                    title: 'Lowest Monthly Premium',
                    value: monthlyPremiums.length ? `$${Math.min(...monthlyPremiums)}` : 'N/A',
                    color: '#059669'
                },
                {
                    title: 'Average Monthly Premium',
                    value: monthlyPremiums.length ? `$${Math.round(monthlyPremiums.reduce((a, b) => a + b, 0) / monthlyPremiums.length)}` : 'N/A',
                    color: '#7C3AED'
                },
                {
                    title: 'Lowest Deductible',
                    value: deductibles.length ? `$${Math.min(...deductibles)}` : 'N/A',
                    color: '#DC2626'
                }
            ];

            summaryCards.innerHTML = summaryData.map(item => `
                <div class="summary-card" style="border-left-color: ${item.color}">
                    <h3>${item.title}</h3>
                    <div class="value" style="color: ${item.color}">${item.value}</div>
                </div>
            `).join('');
        }

        function displayComparisonTable(quotes) {
            const tableBody = document.getElementById('tableBody');
            
            if (!quotes || quotes.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px;">No quotes to display</td></tr>';
                return;
            }

            // Find best values for highlighting
            const monthlyPremiums = quotes.map(q => parseFloat(q.monthly_premium) || Infinity).filter(p => p !== Infinity);
            const deductibles = quotes.map(q => parseFloat(q.deductible) || Infinity).filter(d => d !== Infinity);
            const outOfPocketMaxs = quotes.map(q => parseFloat(q.out_of_pocket_max) || Infinity).filter(o => o !== Infinity);

            const bestMonthly = monthlyPremiums.length ? Math.min(...monthlyPremiums) : null;
            const bestDeductible = deductibles.length ? Math.min(...deductibles) : null;
            const bestOutOfPocket = outOfPocketMaxs.length ? Math.min(...outOfPocketMaxs) : null;

            tableBody.innerHTML = quotes.map(quote => {
                const monthlyPremium = parseFloat(quote.monthly_premium) || 0;
                const deductible = parseFloat(quote.deductible) || 0;
                const outOfPocketMax = parseFloat(quote.out_of_pocket_max) || 0;

                return `
                    <tr class="quote-row">
                        <td class="company-name">${quote.insurance_company || 'N/A'}</td>
                        <td class="plan-name">${quote.plan_name || 'N/A'}</td>
                        <td class="price ${monthlyPremium === bestMonthly && bestMonthly ? 'best-value' : ''}">${monthlyPremium ? '$' + monthlyPremium : 'N/A'}</td>
                        <td class="price">${quote.annual_premium ? '$' + quote.annual_premium : 'N/A'}</td>
                        <td class="${deductible === bestDeductible && bestDeductible ? 'best-value' : ''}">${deductible ? '$' + deductible : 'N/A'}</td>
                        <td class="${outOfPocketMax === bestOutOfPocket && bestOutOfPocket ? 'best-value' : ''}">${outOfPocketMax ? '$' + outOfPocketMax : 'N/A'}</td>
                        <td>${quote.copay_primary_care || 'N/A'}</td>
                        <td>${quote.copay_specialist || 'N/A'}</td>
                        <td>${quote.network_type || 'N/A'}</td>
                        <td>${quote.emergency_room_coverage || 'N/A'}</td>
                        <td>${quote.prescription_coverage || 'N/A'}</td>
                    </tr>
                `;
            }).join('');
        }

        function downloadExcel() {
            if (comparisonData.length === 0) {
                alert('No data to download');
                return;
            }

            // Create CSV content
            const headers = [
                'Quote ID', 'Insurance Company', 'Plan Name', 'Monthly Premium', 'Annual Premium',
                'Deductible', 'Out of Pocket Max', 'Primary Care Copay', 'Specialist Copay',
                'Coinsurance', 'Network Type', 'Coverage Area', 'Emergency Room Coverage',
                'Urgent Care Coverage', 'Prescription Coverage', 'Preventive Care',
                'Mental Health Coverage', 'Maternity Coverage', 'Dental Coverage',
                'Vision Coverage', 'Plan Benefits', 'Processed Date'
            ];

            const csvContent = [
                headers.join(','),
                ...comparisonData.map(quote => [
                    quote.quote_id || '',
                    quote.insurance_company || '',
                    quote.plan_name || '',
                    quote.monthly_premium || '',
                    quote.annual_premium || '',
                    quote.deductible || '',
                    quote.out_of_pocket_max || '',
                    quote.copay_primary_care || '',
                    quote.copay_specialist || '',
                    quote.coinsurance || '',
                    quote.network_type || '',
                    quote.coverage_area || '',
                    quote.emergency_room_coverage || '',
                    quote.urgent_care_coverage || '',
                    quote.prescription_coverage || '',
                    quote.preventive_care || '',
                    quote.mental_health_coverage || '',
                    quote.maternity_coverage || '',
                    quote.dental_coverage || '',
                    quote.vision_coverage || '',
                    quote.plan_benefits || '',
                    quote.processed_date || ''
                ].map(field => `"${field}"`).join(','))
            ].join('\n');

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `insurance_quotes_comparison_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function startNewAnalysis() {
            // Reset form
            selectedFiles = [];
            comparisonData = [];
            updateFileList();
            updateSubmitButton();
            
            // Hide results and show upload
            resultsSection.style.display = 'none';
            uploadSection.style.display = 'block';
            
            // Reset messages
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            progressBar.style.display = 'none';
            progressFill.style.width = '0%';
            
            // Reset file input
            fileInput.value = '';
        }
    </script
